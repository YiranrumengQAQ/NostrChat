<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NostrChat - å»ä¸­å¿ƒåŒ–èŠå¤©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #8b5cf6;
            --primary-dark: #7c3aed;
            --secondary: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --bg-dark: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #475569;
            --online: #22c55e;
            --offline: #64748b;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
        }

        /* ç™»å½•é¡µé¢ */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            animation: gradientShift 10s ease infinite;
        }

        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 450px;
            width: 90%;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .login-title {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, #fff 0%, #e0e7ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
        }

        .login-subtitle {
            text-align: center;
            color: rgba(255,255,255,0.8);
            margin-bottom: 2rem;
            font-size: 0.95rem;
        }

        .login-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .login-btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .login-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.4);
        }

        .login-btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255,255,255,0.3);
        }

        .login-btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        /* ä¸»èŠå¤©ç•Œé¢ */
        .chat-container {
            display: none;
            height: 100vh;
            flex-direction: column;
        }

        .chat-container.active {
            display: flex;
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .navbar {
            background: var(--bg-secondary);
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--border);
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .navbar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .navbar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: var(--bg-tertiary);
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--online);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .latency {
            color: var(--text-secondary);
        }

        .navbar-right {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            background: var(--bg-tertiary);
            border: none;
            color: var(--text-primary);
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .icon-btn:hover {
            background: var(--primary);
            transform: scale(1.05);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
        }

        .sidebar-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
        }

        .sidebar-tab {
            flex: 1;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            border-bottom: 3px solid transparent;
        }

        .sidebar-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .channels-list {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        .channel-item {
            padding: 1rem;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .channel-item:hover {
            background: var(--primary);
            transform: translateX(5px);
        }

        .channel-item.active {
            background: var(--primary);
        }

        .channel-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .channel-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .channel-name {
            font-weight: 600;
        }

        .channel-badge {
            background: var(--danger);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .create-channel-btn {
            margin: 1rem;
            padding: 0.75rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .create-channel-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.02);
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-dark);
        }

        .chat-header {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .chat-members {
            color: var(--text-secondary);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .online-users {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .user-avatar-mini {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--bg-secondary);
            margin-left: -8px;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            display: flex;
            gap: 1rem;
            animation: messageSlide 0.3s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message-content {
            flex: 1;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .message-text {
            color: var(--text-secondary);
            line-height: 1.5;
            word-wrap: break-word;
        }

        .message-image {
            max-width: 400px;
            border-radius: 10px;
            margin-top: 0.5rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-image:hover {
            transform: scale(1.02);
        }

        .message-reactions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .reaction {
            background: var(--bg-tertiary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .reaction:hover {
            background: var(--primary);
        }

        .reaction.active {
            background: var(--primary);
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-area {
            padding: 1rem 1.5rem;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: flex-end;
        }

        .input-box {
            flex: 1;
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 120px;
            min-height: 24px;
        }

        .message-input::placeholder {
            color: var(--text-secondary);
        }

        .input-icon-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 1.25rem;
            transition: color 0.2s;
            padding: 0.25rem;
        }

        .input-icon-btn:hover {
            color: var(--primary);
        }

        .send-btn {
            background: var(--primary);
            border: none;
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.25rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-btn:hover {
            background: var(--primary-dark);
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: var(--bg-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        /* ç§»åŠ¨ç«¯å“åº”å¼ */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 100;
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .navbar-logo {
                font-size: 1.2rem;
            }

            .status-indicator {
                display: none;
            }

            .message-image {
                max-width: 250px;
            }

            .login-box {
                padding: 2rem;
            }
        }

        /* æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-secondary);
            padding: 2rem;
            border-radius: 20px;
            max-width: 500px;
            width: 90%;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            flex: 1;
            padding: 0.75rem;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: var(--text-secondary);
            padding: 2rem;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid var(--bg-tertiary);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--bg-tertiary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--border);
        }

        /* éšè—æ–‡ä»¶è¾“å…¥ */
        #imageUpload {
            display: none;
        }

        /* ä¸Šä¼ è¿›åº¦ */
        .upload-progress {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--bg-secondary);
            padding: 1rem;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 999;
            display: none;
        }

        .upload-progress.active {
            display: block;
        }

        .progress-bar {
            width: 200px;
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <!-- ç™»å½•é¡µé¢ -->
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <h1 class="login-title">NostrChat</h1>
            <p class="login-subtitle">å»ä¸­å¿ƒåŒ–çš„å®‰å…¨èŠå¤©åº”ç”¨</p>

            <button class="login-btn login-btn-primary" onclick="createAccount()">
                ğŸš€ åˆ›å»º Nostr è´¦æˆ·
            </button>

            <button class="login-btn login-btn-secondary" onclick="loginWithKeys()">
                ğŸ”‘ ä½¿ç”¨ç§é’¥ç™»å½•
            </button>

            <button class="login-btn login-btn-secondary" onclick="alert('è¯·å…ˆå®‰è£… Alby æµè§ˆå™¨æ‰©å±•')">
                ğŸ‘› ä½¿ç”¨ NIP-07 é’±åŒ…
            </button>
        </div>
    </div>

    <!-- ä¸»èŠå¤©ç•Œé¢ -->
    <div class="chat-container" id="chatContainer">
        <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
        <div class="navbar">
            <div class="navbar-left">
                <button class="icon-btn" id="menuBtn" onclick="toggleSidebar()">â˜°</button>
                <div class="navbar-logo">NostrChat</div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>åœ¨çº¿</span>
                    <span class="latency" id="latency">0ms</span>
                </div>
            </div>
            <div class="navbar-right">
                <button class="icon-btn" onclick="openSettings()" title="è®¾ç½®">âš™ï¸</button>
                <button class="icon-btn" onclick="logout()" title="é€€å‡º">ğŸšª</button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <!-- ä¾§è¾¹æ  -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-tabs">
                    <button class="sidebar-tab active" onclick="switchTab('channels')">é¢‘é“</button>
                    <button class="sidebar-tab" onclick="switchTab('dms')">ç§èŠ</button>
                    <button class="sidebar-tab" onclick="switchTab('users')">ç”¨æˆ·</button>
                </div>

                <div class="channels-list" id="channelsList">
                    <div class="channel-item active" onclick="switchChannel('global')">
                        <div class="channel-info">
                            <div class="channel-icon">ğŸŒ</div>
                            <div>
                                <div class="channel-name">å…¨çƒèŠå¤©</div>
                            </div>
                        </div>
                        <div class="channel-badge" id="globalBadge" style="display:none;">0</div>
                    </div>
                </div>

                <button class="create-channel-btn" onclick="openCreateChannel()">
                    â• åˆ›å»ºé¢‘é“
                </button>
            </div>

            <!-- èŠå¤©åŒºåŸŸ -->
            <div class="chat-area">
                <div class="chat-header">
                    <div>
                        <div class="chat-title" id="chatTitle">å…¨çƒèŠå¤©</div>
                        <div class="chat-members">
                            <span>ğŸ‘¥</span>
                            <span id="memberCount">0</span>
                            <span>æˆå‘˜åœ¨çº¿</span>
                        </div>
                    </div>
                </div>

                <div class="messages-container" id="messagesContainer">
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>æ­£åœ¨è¿æ¥ Nostr ä¸­ç»§...</span>
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <div class="input-box">
                            <button class="input-icon-btn" onclick="triggerImageUpload()" title="ä¸Šä¼ å›¾ç‰‡">
                                ğŸ“·
                            </button>
                            <input type="file" id="imageUpload" accept="image/*" onchange="handleImageUpload(event)">
                            <textarea 
                                class="message-input" 
                                id="messageInput" 
                                placeholder="è¾“å…¥æ¶ˆæ¯... (æ”¯æŒ@æåŠ)"
                                rows="1"
                                onkeypress="handleKeyPress(event)"
                            ></textarea>
                            <button class="input-icon-btn" onclick="insertEmoji()" title="è¡¨æƒ…">
                                ğŸ˜Š
                            </button>
                        </div>
                        <button class="send-btn" onclick="sendMessage()" id="sendBtn">
                            â¤
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åˆ›å»ºé¢‘é“æ¨¡æ€æ¡† -->
    <div class="modal" id="createChannelModal">
        <div class="modal-content">
            <h2 class="modal-title">åˆ›å»ºæ–°é¢‘é“</h2>
            <div class="form-group">
                <label class="form-label">é¢‘é“åç§°</label>
                <input type="text" class="form-input" id="channelName" placeholder="è¾“å…¥é¢‘é“åç§°">
            </div>
            <div class="form-group">
                <label class="form-label">é¢‘é“æè¿°</label>
                <input type="text" class="form-input" id="channelDesc" placeholder="å¯é€‰">
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('createChannelModal')">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="createChannel()">åˆ›å»º</button>
            </div>
        </div>
    </div>

    <!-- è®¾ç½®æ¨¡æ€æ¡† -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <h2 class="modal-title">è®¾ç½®</h2>
            <div class="form-group">
                <label class="form-label">ä½ çš„å…¬é’¥ (Public Key)</label>
                <input type="text" class="form-input" id="publicKeyDisplay" readonly>
            </div>
            <div class="form-group">
                <label class="form-label">ä½ çš„ç§é’¥ (Private Key) âš ï¸ è¯·å¦¥å–„ä¿å­˜</label>
                <input type="password" class="form-input" id="privateKeyDisplay" readonly>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeModal('settingsModal')">å…³é—­</button>
                <button class="btn btn-primary" onclick="copyKeys()">å¤åˆ¶å¯†é’¥</button>
            </div>
        </div>
    </div>

    <!-- ä¸Šä¼ è¿›åº¦ -->
    <div class="upload-progress" id="uploadProgress">
        <div>æ­£åœ¨ä¸Šä¼ å›¾ç‰‡...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill" style="width: 0%"></div>
        </div>
    </div>

    <!-- å¼•å…¥ Nostr åº“ -->
    <script type="module">
        import { SimplePool, nip19, generateSecretKey, getPublicKey, finalizeEvent } from 'https://esm.sh/nostr-tools@2.1.0';

        // å…¨å±€å˜é‡
        window.pool = new SimplePool();
        window.relays = [
            'wss://relay.damus.io',
            'wss://nos.lol',
            'wss://relay.nostr.band',
            'wss://nostr.wine'
        ];
        window.sk = null;
        window.pk = null;
        window.currentChannel = 'global';
        window.messages = [];
        window.subscriptions = {};
        window.userProfiles = {};

        // ç”Ÿæˆè´¦æˆ·
        window.createAccount = () => {
            const sk = generateSecretKey();
            const pk = getPublicKey(sk);

            localStorage.setItem('nostr_sk', nip19.nsecEncode(sk));
            localStorage.setItem('nostr_pk', nip19.npubEncode(pk));

            window.sk = sk;
            window.pk = pk;

            loginSuccess();
        };

        // ä½¿ç”¨ç§é’¥ç™»å½•
        window.loginWithKeys = () => {
            const nsec = prompt('è¯·è¾“å…¥ä½ çš„ç§é’¥ (nsec...)');
            if (!nsec) return;

            try {
                const { data: sk } = nip19.decode(nsec);
                const pk = getPublicKey(sk);

                localStorage.setItem('nostr_sk', nsec);
                localStorage.setItem('nostr_pk', nip19.npubEncode(pk));

                window.sk = sk;
                window.pk = pk;

                loginSuccess();
            } catch (e) {
                alert('ç§é’¥æ ¼å¼é”™è¯¯ï¼');
            }
        };

        // ç™»å½•æˆåŠŸ
        function loginSuccess() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('chatContainer').classList.add('active');

            connectToRelays();
            subscribeToGlobal();
            measureLatency();
        }

        // è¿æ¥åˆ°ä¸­ç»§
        function connectToRelays() {
            console.log('Connecting to relays:', window.relays);
        }

        // è®¢é˜…å…¨å±€èŠå¤©
        function subscribeToGlobal() {
            const sub = window.pool.subscribeMany(
                window.relays,
                [
                    {
                        kinds: [1, 42],
                        limit: 50
                    }
                ],
                {
                    onevent(event) {
                        handleNewMessage(event);
                    },
                    oneose() {
                        document.querySelector('.loading').style.display = 'none';
                    }
                }
            );

            window.subscriptions['global'] = sub;
        }

        // å¤„ç†æ–°æ¶ˆæ¯
        function handleNewMessage(event) {
            if (window.messages.find(m => m.id === event.id)) return;

            window.messages.push(event);
            window.messages.sort((a, b) => a.created_at - b.created_at);

            renderMessages();
            fetchUserProfile(event.pubkey);
        }

        // æ¸²æŸ“æ¶ˆæ¯
        function renderMessages() {
            const container = document.getElementById('messagesContainer');
            const loading = container.querySelector('.loading');
            if (loading) loading.style.display = 'none';

            // åªæ¸²æŸ“æœ€æ–°çš„æ¶ˆæ¯ï¼Œé¿å…é‡å¤æ¸²æŸ“
            const lastMessages = window.messages.slice(-50);

            container.innerHTML = lastMessages.map(msg => {
                const profile = window.userProfiles[msg.pubkey] || {};
                const name = profile.name || msg.pubkey.slice(0, 8);
                const avatar = name[0].toUpperCase();
                const time = new Date(msg.created_at * 1000).toLocaleTimeString('zh-CN', {
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // æ£€æŸ¥æ˜¯å¦åŒ…å«å›¾ç‰‡é“¾æ¥
                const imageMatch = msg.content.match(/(https?:\/\/[^\s]+\.(jpg|jpeg|png|gif|webp))/i);
                const imageHtml = imageMatch ? 
                    `<img src="${imageMatch[0]}" class="message-image" onclick="window.open('${imageMatch[0]}', '_blank')">` : '';

                return `
                    <div class="message">
                        <div class="message-avatar">${avatar}</div>
                        <div class="message-content">
                            <div class="message-header">
                                <span class="message-author">${name}</span>
                                <span class="message-time">${time}</span>
                            </div>
                            <div class="message-text">${escapeHtml(msg.content)}</div>
                            ${imageHtml}
                            <div class="message-reactions">
                                <div class="reaction" onclick="addReaction('${msg.id}', 'ğŸ‘')">ğŸ‘ <span>0</span></div>
                                <div class="reaction" onclick="addReaction('${msg.id}', 'â¤ï¸')">â¤ï¸ <span>0</span></div>
                                <div class="reaction" onclick="addReaction('${msg.id}', 'ğŸ˜‚')">ğŸ˜‚ <span>0</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.scrollTop = container.scrollHeight;
        }

        // è½¬ä¹‰HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // è·å–ç”¨æˆ·èµ„æ–™
        async function fetchUserProfile(pubkey) {
            if (window.userProfiles[pubkey]) return;

            const sub = window.pool.subscribeMany(
                window.relays,
                [{ kinds: [0], authors: [pubkey] }],
                {
                    onevent(event) {
                        try {
                            const profile = JSON.parse(event.content);
                            window.userProfiles[pubkey] = profile;
                            renderMessages();
                        } catch (e) {}
                    }
                }
            );

            setTimeout(() => sub.close(), 5000);
        }

        // å‘é€æ¶ˆæ¯
        window.sendMessage = async () => {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();

            if (!content) return;

            const event = finalizeEvent({
                kind: 1,
                created_at: Math.floor(Date.now() / 1000),
                tags: [],
                content: content
            }, window.sk);

            await window.pool.publish(window.relays, event);

            input.value = '';
            input.style.height = 'auto';
        };

        // å¤„ç†å›¾ç‰‡ä¸Šä¼ 
        window.handleImageUpload = async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const progress = document.getElementById('uploadProgress');
            const progressFill = document.getElementById('progressFill');
            progress.classList.add('active');

            try {
                // æ¨¡æ‹Ÿä¸Šä¼ åˆ° nostr.build
                progressFill.style.width = '30%';

                const formData = new FormData();
                formData.append('file', file);

                progressFill.style.width = '60%';

                // è¿™é‡Œåº”è¯¥è°ƒç”¨å®é™…çš„ nostr.build API
                // ç”±äºè·¨åŸŸé™åˆ¶ï¼Œè¿™é‡Œä½¿ç”¨æ¨¡æ‹Ÿ
                await new Promise(resolve => setTimeout(resolve, 1000));

                progressFill.style.width = '100%';

                // æ¨¡æ‹Ÿè¿”å›çš„å›¾ç‰‡URL
                const imageUrl = URL.createObjectURL(file);

                // å°†å›¾ç‰‡URLæ’å…¥åˆ°è¾“å…¥æ¡†
                const input = document.getElementById('messageInput');
                input.value += `\n${imageUrl}`;

                setTimeout(() => {
                    progress.classList.remove('active');
                    progressFill.style.width = '0%';
                }, 500);

                alert('å›¾ç‰‡ä¸Šä¼ æˆåŠŸï¼\næ³¨æ„ï¼šè¿™æ˜¯æœ¬åœ°é¢„è§ˆURLï¼Œå®é™…ä½¿ç”¨éœ€è¦é…ç½®nostr.build APIå¯†é’¥');
            } catch (e) {
                alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥ï¼š' + e.message);
                progress.classList.remove('active');
            }
        };

        // è§¦å‘å›¾ç‰‡ä¸Šä¼ 
        window.triggerImageUpload = () => {
            document.getElementById('imageUpload').click();
        };

        // æµ‹é‡å»¶è¿Ÿ
        async function measureLatency() {
            setInterval(async () => {
                const start = Date.now();
                try {
                    await fetch(window.relays[0].replace('wss://', 'https://').replace('ws://', 'http://'), {
                        mode: 'no-cors'
                    });
                } catch (e) {}
                const latency = Date.now() - start;
                document.getElementById('latency').textContent = `${latency}ms`;
            }, 5000);
        }

        // åˆ‡æ¢ä¾§è¾¹æ 
        window.toggleSidebar = () => {
            document.getElementById('sidebar').classList.toggle('active');
        };

        // æ‰“å¼€è®¾ç½®
        window.openSettings = () => {
            document.getElementById('publicKeyDisplay').value = localStorage.getItem('nostr_pk');
            document.getElementById('privateKeyDisplay').value = localStorage.getItem('nostr_sk');
            document.getElementById('settingsModal').classList.add('active');
        };

        // å¤åˆ¶å¯†é’¥
        window.copyKeys = () => {
            const text = `å…¬é’¥: ${localStorage.getItem('nostr_pk')}\nç§é’¥: ${localStorage.getItem('nostr_sk')}`;
            navigator.clipboard.writeText(text);
            alert('å¯†é’¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼è¯·å¦¥å–„ä¿å­˜ã€‚');
        };

        // å…³é—­æ¨¡æ€æ¡†
        window.closeModal = (id) => {
            document.getElementById(id).classList.remove('active');
        };

        // æ‰“å¼€åˆ›å»ºé¢‘é“
        window.openCreateChannel = () => {
            document.getElementById('createChannelModal').classList.add('active');
        };

        // åˆ›å»ºé¢‘é“
        window.createChannel = () => {
            const name = document.getElementById('channelName').value.trim();
            if (!name) {
                alert('è¯·è¾“å…¥é¢‘é“åç§°');
                return;
            }

            alert('é¢‘é“åˆ›å»ºåŠŸèƒ½å¼€å‘ä¸­...');
            closeModal('createChannelModal');
        };

        // é€€å‡ºç™»å½•
        window.logout = () => {
            if (confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem('nostr_sk');
                localStorage.removeItem('nostr_pk');
                location.reload();
            }
        };

        // æŒ‰é”®å¤„ç†
        window.handleKeyPress = (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        };

        // æ’å…¥è¡¨æƒ…
        window.insertEmoji = () => {
            const emojis = ['ğŸ˜€', 'ğŸ˜‚', 'ğŸ˜', 'ğŸ¥³', 'ğŸ˜', 'ğŸ¤”', 'ğŸ‘', 'â¤ï¸', 'ğŸ”¥', 'âœ¨'];
            const emoji = emojis[Math.floor(Math.random() * emojis.length)];
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
        };

        // æ·»åŠ ååº”
        window.addReaction = async (messageId, emoji) => {
            const event = finalizeEvent({
                kind: 7,
                created_at: Math.floor(Date.now() / 1000),
                tags: [
                    ['e', messageId],
                    ['content', emoji]
                ],
                content: emoji
            }, window.sk);

            await window.pool.publish(window.relays, event);
        };

        // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
        if (localStorage.getItem('nostr_sk')) {
            try {
                const { data: sk } = nip19.decode(localStorage.getItem('nostr_sk'));
                const pk = getPublicKey(sk);
                window.sk = sk;
                window.pk = pk;
                loginSuccess();
            } catch (e) {
                console.error('Failed to restore session:', e);
            }
        }
    </script>
</body>
</html>
